STASE has two major components. Follow the steps to install the required tools and dependencies.  These steps were tested on LLVM 14 and Ubuntu (22.04 LTS). 

# 1. Rule-based Static Analysis

## Step-1: Install cclyzerpp & Souffle 
STASE uses cclyzerpp and Souffle tools for rule-based static analysis. Follow [these steps](install_sa.md) to install cclyzerpp and Souffle.

## Step-2: Clone edk2 source code
```
git clone <Your edk2 repo> (Assuming the directory name will be edk2)
cd edk2
git submodule update --init
```

## Step-3: Compile source code with clang-14
- In Conf/tools_def.txt, add the following flags “-flto -Xclang -disable-O0-optnone” At the end of line “NOOPT_CLANGPDB_X64_CC_FLAGS” option

- Compile OvmfPkgX64 to generate .obj files
```
source ./edksetup.sh
make -C BaseTools
build -a X64 -b NOOPT -n 4 -d 2 -t CLANGPDB -p OvmfPkg/OvmfPkgX64.dsc -D NETWORK_IP6_ENABLE=TRUE -D SMM_REQUIRE=TRUE
```
- Extract the required files: "<filename>.obj" files from Build directory and rename them as "<filename>.bc" files

- You can also use the files from bcfiles folder uploaded here

## Step-4: Run the analysis for each .bc file
```
mkdir ./<filename>_facts
mkdir ./<filename>_analysis
factgen-exe --context-sensitivity 9-callsite ./bcfiles/<filename>.bc -o ./<filename>_facts/
souffle --no-warn -j 32 -F ./<filename>_facts/ -D ./<filename>_analysis/ ./edk2_dependence.project
```


# 2. Guided Symbolic Execution

## Step-1: Install KLEE Symbolic Execution Engine 
STASE uses KLEE as the underlying symbolic execution engine. Follow [these steps](install_klee.md) to install KLEE.
## Step-2: Clone edk2 source code inside stase directory
```
cd stase
git clone <Your edk2 repo> (Assuming the directory name will be edk2)
cd edk2
cd ..
```

## Step-3: Generate harness for symbolic execution environment
- Process header files for local communication
```
cd edk2
python3 ../process_headers.py $(pwd)
cd ..
```

- Remove macros that are incompatible with symbolic execution.
```
python3 remove_macros.py
```
- Add protocol Protocol GUIDs in static_harness file

## Step-4: Generate harness for execution control (Guided symbolic execution)

Do the following steps using the vulnerability report generated by static analysis (Examples are added in dynamic_harness directory):

- Define symbolic variables
- Substitute non-critical functions with stubs 
    Example script to generate stubs:
    ```
    python3 generate_stubs.py
    ```
- Add assertions for validation



## Step-5: Build
```
clang-13 -emit-llvm -c -g -O0 -Xclang -disable-O0-optnone stase_driver.c
```
## Step-6: Run Symbolic Execution
```
klee --external-calls=all -libc=uclibc --posix-runtime --smtlib-human-readable  --write-test-info --write-paths --write-smt2s   --write-cov  --write-cvcs --write-kqueries   --write-sym-paths --only-output-states-covering-new --use-query-log=solver:smt2  --simplify-sym-indices stase_driver.bc
```

# Repository Structure
- static_harness.c: Environment Configuration Harness (ECH)
- dynamic_harness: Examples of Path Exploration Harnesses
- stase_driver.c: STASE main
- klee_driver.c: SymExec with ECH
- edk2_dependence.project: Static analysis rule file



